{%- render 'section-spacing-collapsing' -%}

{%- assign text_position = section.settings.text_position -%}

{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
CSS
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

<style>
  #shopify-section-{{ section.id }}{
    --section-stack-intro: {% if text_position == 'center' %}50%{% else %}33.3333%{% endif %};
    --section-stack-main: {% if text_position == 'center' and section.settings.expand_image %}100%{% else %}66.6667%{% endif %};

    --before-after-initial-drag-position: {{ section.settings.drag_initial_position }}%;

    /* ===== AI SCAN THEME (tweak) ===== */
    --ai-neon-1: #ff5fa2;
    --ai-neon-2: #9b5cff;
    --ai-neon-3: #2ec5ff;
    --ai-glow: rgba(155,92,255,.35);
    --ai-glass: rgba(255,255,255,.06);
  }

  /* =========================
     AI SCAN “WAAAH” EFFECT
     ========================= */

  /* Bloc principal */
  #shopify-section-{{ section.id }} .before-after{
    position: relative;
    border-radius: 28px;
    overflow: hidden;

    background: linear-gradient(135deg,
      rgba(255,95,162,.16),
      rgba(155,92,255,.16),
      rgba(46,197,255,.16)
    );
    backdrop-filter: blur(14px);

    box-shadow:
      0 0 0 1px rgba(255,255,255,.10),
      0 30px 90px var(--ai-glow),
      inset 0 0 50px var(--ai-glass);
  }

  /* Halo animé */
  #shopify-section-{{ section.id }} .before-after::before{
    content:"";
    position:absolute;
    inset:-2px;
    border-radius: inherit;
    background: linear-gradient(120deg,
      var(--ai-neon-1),
      var(--ai-neon-2),
      var(--ai-neon-3),
      var(--ai-neon-1)
    );
    background-size: 300% 300%;
    animation: aiNeonFlow 6.5s linear infinite;
    opacity:.55;
    z-index: 0;
    pointer-events:none;
  }

  @keyframes aiNeonFlow{
    0%{ background-position: 0% 50%; }
    50%{ background-position: 100% 50%; }
    100%{ background-position: 0% 50%; }
  }

  /* Contenu au-dessus du halo */
  #shopify-section-{{ section.id }} .before-after > *{
    position: relative;
    z-index: 1;
  }

  /* Images plus premium */
  #shopify-section-{{ section.id }} .before-after img{
    filter: saturate(1.12) contrast(1.06);
    transition: transform .6s cubic-bezier(.2,.8,.2,1);
  }
  #shopify-section-{{ section.id }} .before-after:hover img{
    transform: scale(1.015);
  }

  /* Curseur + ligne centrale cyber */
  #shopify-section-{{ section.id }} .before-after__cursor svg{
    filter:
      drop-shadow(0 0 14px rgba(155,92,255,.8))
      drop-shadow(0 0 30px rgba(46,197,255,.6));
  }

  #shopify-section-{{ section.id }} .before-after__cursor-wrapper{
    position: relative;
  }

  /* Ligne verticale lumineuse au centre */
  #shopify-section-{{ section.id }} .before-after__cursor-wrapper::after{
    content:"";
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    left:50%;
    transform: translateX(-50%);
    background: linear-gradient(
      to bottom,
      transparent,
      rgba(155,92,255,.9),
      rgba(46,197,255,.9),
      transparent
    );
    opacity:.85;
    pointer-events:none;
    z-index: 3;
    mix-blend-mode: screen;
  }

  /* Labels glass */
  #shopify-section-{{ section.id }} .before-after__label{
    padding: 8px 14px;
    border-radius: 999px;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(10px);
    box-shadow:
      0 0 0 1px rgba(255,255,255,.14),
      0 10px 30px rgba(0,0,0,.35);
    letter-spacing: .6px;
    text-transform: uppercase;
  }

  /* ===== AI SCAN LINE (sur tout le bloc) =====
     - pas besoin de JS
     - en hover sur desktop
     - auto sur mobile (pas de hover)
  */
  #shopify-section-{{ section.id }} .before-after::after{
    content:"";
    position:absolute;
    left:-30%;
    top:0;
    width: 45%;
    height: 100%;

    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(46,197,255,.00) 20%,
      rgba(46,197,255,.18) 45%,
      rgba(255,255,255,.38) 50%,
      rgba(155,92,255,.18) 55%,
      rgba(155,92,255,.00) 80%,
      transparent 100%
    );

    transform: skewX(-12deg) translateX(-120%);
    filter: blur(.2px);
    opacity: 0;
    pointer-events:none;
    z-index: 4;
    mix-blend-mode: screen;
  }

  /* Desktop: scan quand hover */
  @media (hover:hover){
    #shopify-section-{{ section.id }} .before-after:hover::after{
      opacity: 1;
      animation: aiScan 1.35s ease-in-out 1;
    }
  }

  /* Mobile: scan automatique doux */
  @media (hover:none){
    #shopify-section-{{ section.id }} .before-after::after{
      opacity: .9;
      animation: aiScan 3.2s ease-in-out infinite;
    }
  }

  @keyframes aiScan{
    0%   { transform: skewX(-12deg) translateX(-140%); opacity: 0; }
    8%   { opacity: 1; }
    50%  { opacity: 1; }
    100% { transform: skewX(-12deg) translateX(320%); opacity: 0; }
  }

  /* Option: réduit l’animation si l’utilisateur préfère */
  @media (prefers-reduced-motion: reduce){
    #shopify-section-{{ section.id }} .before-after::before,
    #shopify-section-{{ section.id }} .before-after::after,
    #shopify-section-{{ section.id }} .draw-line{
      animation: none !important;
    }
  }
</style>

{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
LIQUID
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

{%- capture sizes -%}
  (max-width: 999px) 100vw,
  {% if text_position == 'center' and section.settings.expand_image %}
    min({{ settings.page_width }}px, 100vw)
  {% else %}
    1000px
  {% endif %}
{%- endcapture -%}

<div {% render 'section-properties' %}>
  <div class="section-stack {% if text_position != 'center' %}section-stack--horizontal{% else %}section-stack--center{% endif %} {% if text_position == 'end' %}section-stack--reverse{% endif %}">
    {%- capture content -%}
      {%- if section.settings.subheading != blank -%}
        <p class="subheading">{{ section.settings.subheading | escape }}</p>
      {%- endif -%}

      {%- if section.settings.title != blank -%}
        <h2 class="h2">{{ section.settings.title | escape }}</h2>
      {%- endif -%}

      {{- section.settings.content -}}
    {%- endcapture -%}

    {%- if content != blank -%}
      <div class="section-stack__intro">
        <div class="prose {% if text_position == 'center' %}text-center{% endif %}">
          {{ content }}
        </div>
      </div>
    {%- endif -%}

    <div class="section-stack__main">
      <div {% render 'surface', class: 'before-after shadow', text_color: section.settings.before_text_color %}>
        <!-- BEFORE -->
        <div {% render 'surface', class: 'before-after__before-image', text_color: section.settings.before_text_color %}>
          {%- if section.settings.before_image != blank -%}
            <picture>
              {%- if section.settings.before_image_mobile != blank -%}
                <source
                  media="(max-width: 699px)"
                  srcset="
                    {{ section.settings.before_image_mobile | image_url: width: 400 }} 400w,
                    {{ section.settings.before_image_mobile | image_url: width: 600 }} 600w,
                    {{ section.settings.before_image_mobile | image_url: width: 800 }} 800w,
                    {{ section.settings.before_image_mobile | image_url: width: 1000 }} 1000w"
                  width="{{ section.settings.before_image_mobile.width }}"
                  height="{{ section.settings.before_image_mobile.height }}"
                >
              {%- endif -%}

              {{-
                section.settings.before_image
                | image_url: width: section.settings.before_image.width
                | image_tag:
                  sizes: sizes,
                  widths: '300,400,500,600,800,1000,1200,1400,1600,1800,2000',
                  draggable: false,
                  class: 'rounded w-full',
                  loading: 'eager',
                  fetchpriority: 'high'
              -}}
            </picture>
          {%- else -%}
            {{- 'lifestyle-1' | placeholder_svg_tag: 'placeholder rounded' | replace: '<svg', '<svg preserveAspectRatio="xMinYMin slice"' -}}
          {%- endif -%}

          {%- if section.settings.before_text != blank -%}
            <p class="before-after__label before-after__label--left before-after__label--{{ section.settings.before_after_text_position }} h5">
              {{- section.settings.before_text | escape -}}
            </p>
          {%- endif -%}
        </div>

        <!-- AFTER -->
        <div {% render 'surface', class: 'before-after__after-image', text_color: section.settings.after_text_color %}>
          {%- if section.settings.after_image != blank -%}
            <picture>
              {%- if section.settings.after_image_mobile != blank -%}
                <source
                  media="(max-width: 699px)"
                  srcset="
                    {{ section.settings.after_image_mobile | image_url: width: 400 }} 400w,
                    {{ section.settings.after_image_mobile | image_url: width: 600 }} 600w,
                    {{ section.settings.after_image_mobile | image_url: width: 800 }} 800w,
                    {{ section.settings.after_image_mobile | image_url: width: 1000 }} 1000w"
                  width="{{ section.settings.after_image_mobile.width }}"
                  height="{{ section.settings.after_image_mobile.height }}"
                >
              {%- endif -%}

              {{-
                section.settings.after_image
                | image_url: width: section.settings.after_image.width
                | image_tag:
                  sizes: sizes,
                  widths: '300,400,500,600,800,1000,1200,1400,1600,1800,2000',
                  draggable: false,
                  class: 'rounded w-full object-cover',
                  loading: 'lazy'
              -}}
            </picture>
          {%- else -%}
            {{- 'lifestyle-2' | placeholder_svg_tag: 'bg-text filter-invert rounded' | replace: '<svg', '<svg preserveAspectRatio="xMinYMin slice"' -}}
          {%- endif -%}

          {%- if section.settings.after_text != blank -%}
            <p class="before-after__label before-after__label--right before-after__label--{{ section.settings.before_after_text_position }} h5">
              {{- section.settings.after_text | escape -}}
            </p>
          {%- endif -%}
        </div>

        <!-- CURSOR -->
        <div class="before-after__cursor-wrapper">
          <split-cursor class="before-after__cursor" style="--background: {{ section.settings.drag_cursor_background.rgb }}">
            <span class="sr-only">{{ 'general.accessibility.drag' | t }}</span>

            <svg role="presentation" focusable="false" width="28" height="35" viewBox="0 0 32 40">
              <path d="M0 16C0 7.16344 7.16344 0 16 0C24.8366 0 32 7.16344 32 16V24C32 32.8366 24.8366 40 16 40C7.16344 40 0 32.8366 0 24V16Z" fill="{{ section.settings.drag_cursor_background }}"></path>
              <path fill="{{ section.settings.drag_cursor_color }}" d="M11 14H13V26H11zM15 14H17V26H15zM19 14H21V26H19z"></path>
            </svg>
          </split-cursor>
        </div>
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Before/after image",
  "class": "shopify-section--before-after-image",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    { "type": "checkbox", "id": "full_width", "label": "Full width", "default": true },
    { "type": "text", "id": "subheading", "label": "Subheading" },
    { "type": "text", "id": "title", "label": "Heading", "default": "Before/after" },
    { "type": "richtext", "id": "content", "label": "Content", "default": "<p>Showcase your product benefit by using before/after image comparison.</p>" },

    { "type": "image_picker", "id": "before_image", "label": "Before image", "info": "2000 x 1200px .jpg recommended" },
    { "type": "image_picker", "id": "before_image_mobile", "label": "Before image (mobile)", "info": "1200 x 1200px .jpg recommended" },

    { "type": "image_picker", "id": "after_image", "label": "After image", "info": "Dimensions must match before image." },
    { "type": "image_picker", "id": "after_image_mobile", "label": "After image (mobile)", "info": "1200 x 1200px .jpg recommended" },

    { "type": "checkbox", "id": "expand_image", "label": "Expand image", "info": "Only applicable when text position is set to center.", "default": false },

    {
      "type": "select",
      "id": "text_position",
      "label": "Text position",
      "options": [
        { "value": "start", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "end", "label": "Right" }
      ],
      "default": "start"
    },

    {
      "type": "select",
      "id": "before_after_text_position",
      "label": "Before/after text position",
      "options": [
        { "value": "top", "label": "Top" },
        { "value": "bottom", "label": "Bottom" }
      ],
      "default": "top"
    },

    { "type": "text", "id": "before_text", "label": "Before text", "default": "Before" },
    { "type": "text", "id": "after_text", "label": "After text", "default": "After" },

    { "type": "range", "id": "drag_initial_position", "min": 0, "max": 100, "unit": "%", "label": "Drag initial position", "default": 50 },

    { "type": "header", "content": "Colors", "info": "Gradient replaces solid colors when set." },
    { "type": "color", "id": "background", "label": "Background" },
    { "type": "color_background", "id": "background_gradient", "label": "Background gradient" },
    { "type": "color", "id": "text_color", "label": "Text" },

    { "type": "color", "id": "before_text_color", "label": "Before text", "default": "#ffffff" },
    { "type": "color", "id": "after_text_color", "label": "After text", "default": "#ffffff" },

    { "type": "color", "id": "drag_cursor_background", "label": "Drag cursor background", "default": "#ffffff" },
    { "type": "color", "id": "drag_cursor_color", "label": "Drag cursor color", "default": "#000000" }
  ],
  "presets": [
    { "name": "Before/after image" }
  ]
}
{% endschema %}
