{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
NOTE TO DEVELOPERS: welcome to Impact theme! We hope that you will enjoy editing this theme as much as we did for
  developing it. We have put a lot of work to make this theme as developer friendly as possible by offering you
  hooks to integrate into critical parts of the theme. You will find the complete technical documentation (including
  all events, dependencies...) in the "documentation.txt" file, located in the Assets folder.
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

<!doctype html>

<html lang="{{ request.locale.iso_code }}" dir="{% render 'direction' %}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="{{ settings.header_background }}">

    <title>{% if page_title == blank %}{{ shop.name }}{% else %}{{ page_title }}{% if current_page != 1 %} &ndash; {{ 'general.page' | t: page: current_page }}{% endif %}{% endif %}</title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    <link rel="canonical" href="{{ canonical_url }}">

    {%- if settings.favicon -%}
      <link rel="shortcut icon" href="{{ settings.favicon | image_url: width: 96 }}">
      <link rel="apple-touch-icon" href="{{ settings.favicon | image_url: width: 180 }}">
    {%- endif -%}

    {%- comment -%}Few prefetch to increase performance on commonly used third-parties{%- endcomment -%}
    <link rel="preconnect" href="https://cdn.shopify.com">
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://productreviews.shopifycdn.com">

    {%- unless settings.heading_font.system? -%}
      <link rel="preload" href="{{ settings.heading_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- unless settings.text_font.system? -%}
      <link rel="preload" href="{{ settings.text_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- render 'social-meta-tags' -%}
    {%- render 'microdata-schema' -%}
    {%- render 'css-variables' -%}
    {%- render 'js-variables' -%}

    <script>
      if (!(HTMLScriptElement.supports && HTMLScriptElement.supports('importmap'))) {
        const importMapPolyfill = document.createElement('script');
        importMapPolyfill.async = true;
        importMapPolyfill.src = "{{ 'es-module-shims.min.js' | asset_url }}";

        document.head.appendChild(importMapPolyfill);
      }
    </script>

    <script type="importmap">
      {%- comment -%}On Safari 16.3 and lower, a polyfill is used to load importmap{%- endcomment -%}
      {
        "imports": {
          "vendor": "{{ 'vendor.min.js' | asset_url }}",
          "theme": "{{ 'theme.js' | asset_url }}",
          "photoswipe": "{{ 'photoswipe.min.js' | asset_url }}"
        }
      }
    </script>

    <script type="module" src="{{ 'vendor.min.js' | asset_url }}"></script>
    <script type="module" src="{{ 'theme.js' | asset_url }}"></script>

    {{ content_for_header }}

 {{ 'theme.css' | asset_url | stylesheet_tag: preload: true }}
 
  <meta name="facebook-domain-verification" content="r6215rl74qi6yxok27svncs4942yzw" />  

<!-- TikTok Pixel Code Start -->
<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};


  ttq.load('D5G2UJRC77U3DS9AQU4G');
  ttq.page();
}(window, document, 'ttq');
</script>
<!-- TikTok Pixel Code End -->
</head>


  <body class="{% if settings.zoom_image_on_hover %}zoom-image--enabled{% endif %}">
    {%- render 'shadow-dom-templates' -%}

    <a href="#main" class="skip-to-content sr-only">{{ 'general.accessibility.skip_to_content' | t }}</a>

    {%- if request.page_type != 'password' -%}
      {%- sections 'header-group' -%}
      {%- sections 'overlay-group' -%}

      {%- if settings.cart_type == 'popover' -%}
        <cart-notification-drawer open-from="bottom" class="quick-buy-drawer drawer"></cart-notification-drawer>
      {%- endif -%}
    {%- endif -%}

    {%- if request.page_type == 'customers/account' or request.page_type == 'customers/order' or request.page_type == 'customers/addresses' -%}
      {%- section 'account-banner' -%}
    {%- endif -%}

    <main role="main" id="main" class="anchor">
      {{ content_for_layout }}

      {%- comment -%}
      IMPLEMENTATION NOTE: due to the very complex logic of margin/padding collapsing in Impact, the footer group is
      added into the main element to ensure that dynamic sections added into the footer group are properly laid out.
      {%- endcomment -%}
      {%- if request.page_type != 'password' -%}
        {%- sections 'footer-group' -%}
      {%- endif -%}
    </main>









<!-- ELINEA AI CHAT - FULL WIDGET (replace old widget) -->
<style>
  #elinea-chat-root { position: fixed; bottom: 18px; right: 18px; z-index: 999999; font-family: Arial, sans-serif; }
  #elinea-chat-btn {
    border: 0; cursor: pointer; border-radius: 999px; padding: 12px 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15); background: #111; color: #fff; font-weight: 700;
  }
  #elinea-chat-box {
    display: none; width: 340px; height: 480px; background: #fff; border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.18); overflow: hidden; margin-top: 10px;
  }
  #elinea-chat-top { padding: 12px 14px; font-weight: 800; border-bottom: 1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
  #elinea-chat-top small { font-weight: 600; opacity: .7; }
  #elinea-chat-messages { padding: 12px 14px; height: 318px; overflow: auto; font-size: 14px; background: #fafafa; }
  .elinea-msg { margin: 10px 0; white-space: pre-wrap; }
  .elinea-bubble { display:inline-block; padding: 10px 12px; border-radius: 14px; max-width: 92%; }
  .elinea-user { text-align: right; }
  .elinea-user .elinea-bubble { background: #111; color:#fff; border-bottom-right-radius: 6px; }
  .elinea-assistant .elinea-bubble { background: #fff; color:#111; border: 1px solid #eee; border-bottom-left-radius: 6px; }
  #elinea-quick { padding: 10px 12px; border-top: 1px solid #eee; background:#fff; display:flex; flex-wrap: wrap; gap: 8px; }
  .elinea-chip { border: 1px solid #e7e7e7; background:#fff; padding: 8px 10px; border-radius: 999px; cursor:pointer; font-size: 13px; }
  #elinea-inputbar { display:flex; gap: 8px; padding: 10px; border-top: 1px solid #eee; background:#fff; }
  #elinea-input { flex:1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
  #elinea-send { padding: 10px 12px; border-radius: 10px; border: 0; cursor: pointer; background:#111; color:#fff; font-weight:700; }
  #elinea-tools { display:flex; gap: 8px; align-items:center; }
  #elinea-min { border: 0; cursor:pointer; background: transparent; font-size: 18px; line-height: 1; }
  #elinea-whatsapp {
    display:none; padding: 10px 12px; border-top:1px solid #eee; background:#fff;
  }
  #elinea-whatsapp a {
    display:block; text-align:center; text-decoration:none; font-weight:800;
    padding: 10px 12px; border-radius: 12px; border: 1px solid #e7e7e7;
  }
  #elinea-typing { display:none; padding: 0 14px 10px; font-size: 12px; opacity: .7; background:#fafafa; }
</style>

<div id="elinea-chat-root">
  <button id="elinea-chat-btn">ðŸ’¬ Besoin dâ€™aide ?</button>

  <div id="elinea-chat-box">
    <div id="elinea-chat-top">
      <div>
        Assistant ELINEA<br>
        <small>RÃ©ponse en quelques secondes</small>
      </div>
      <div id="elinea-tools">
        <button id="elinea-min" title="RÃ©duire">âœ•</button>
      </div>
    </div>

    <div id="elinea-chat-messages"></div>
    <div id="elinea-typing">ELINEA est en train dâ€™Ã©crireâ€¦</div>

    <div id="elinea-quick">
      <button class="elinea-chip" data-q="Est-ce adaptÃ© aux peaux sensibles ?">Peau sensible</button>
      <button class="elinea-chip" data-q="Puis-je lâ€™utiliser sous la douche ?">Sous la douche</button>
      <button class="elinea-chip" data-q="Quels sont les dÃ©lais de livraison ?">Livraison</button>
      <button class="elinea-chip" data-q="Comment fonctionnent les retours ?">Retours</button>
    </div>

    <div id="elinea-whatsapp">
      <a id="elinea-wa-link" href="#" target="_blank" rel="noopener">ðŸ“² Parler au SAV sur WhatsApp</a>
    </div>

    <div id="elinea-inputbar">
      <input id="elinea-input" placeholder="Ã‰cris ta questionâ€¦" />
      <button id="elinea-send">Envoyer</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const API_BASE = "TON_URL_RENDER"; // ex: "https://elinea-chat.onrender.com"
  const WHATSAPP_NUMBER = "TON_NUM_WHATSAPP"; // ex: "33612345678" (format international sans +)
  const AUTO_OPEN_AFTER_MS = 25000; // 25s (met 0 pour dÃ©sactiver)
  const SHOW_WHATSAPP_AFTER_TURNS = 2; // aprÃ¨s 2 questions
  // ====================

  const btn = document.getElementById("elinea-chat-btn");
  const box = document.getElementById("elinea-chat-box");
  const messages = document.getElementById("elinea-chat-messages");
  const input = document.getElementById("elinea-input");
  const send = document.getElementById("elinea-send");
  const minBtn = document.getElementById("elinea-min");
  const typing = document.getElementById("elinea-typing");
  const waWrap = document.getElementById("elinea-whatsapp");
  const waLink = document.getElementById("elinea-wa-link");

  let turnCount = 0;

  let sessionId = localStorage.getItem("elinea_session_id");
  if (!sessionId) {
    sessionId = Math.random().toString(16).slice(2) + Date.now().toString(16);
    localStorage.setItem("elinea_session_id", sessionId);
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function addMsg(role, text) {
    const wrap = document.createElement("div");
    wrap.className = "elinea-msg " + (role === "user" ? "elinea-user" : "elinea-assistant");
    const bubble = document.createElement("div");
    bubble.className = "elinea-bubble";
    bubble.innerHTML = escapeHtml(text);
    wrap.appendChild(bubble);
    messages.appendChild(wrap);
    messages.scrollTop = messages.scrollHeight;
  }

  function openChat() {
    box.style.display = "block";
    btn.style.display = "none";
    if (!messages.dataset.welcome) {
      addMsg("assistant",
        "Salut ðŸ‘‹ Je peux tâ€™aider Ã  choisir ELINEA en 30 secondes.\n" +
        "Tu veux plutÃ´t :\n" +
        "â€¢ Infos produit\n" +
        "â€¢ Livraison / retours\n" +
        "â€¢ Est-ce adaptÃ© Ã  ta peau ?"
      );
      messages.dataset.welcome = "1";
    }
  }

  function closeChat() {
    box.style.display = "none";
    btn.style.display = "inline-block";
  }

  btn.onclick = openChat;
  minBtn.onclick = closeChat;

  // Auto open (once per session)
  if (AUTO_OPEN_AFTER_MS > 0 && !sessionStorage.getItem("elinea_auto_opened")) {
    setTimeout(() => {
      if (btn.style.display !== "none") {
        openChat();
        sessionStorage.setItem("elinea_auto_opened", "1");
      }
    }, AUTO_OPEN_AFTER_MS);
  }

  // Quick chips
  document.querySelectorAll(".elinea-chip").forEach(chip => {
    chip.addEventListener("click", () => sendMsg(chip.getAttribute("data-q")));
  });

  function showTyping(on) {
    typing.style.display = on ? "block" : "none";
    messages.scrollTop = messages.scrollHeight;
  }

  function maybeShowWhatsApp() {
    if (!WHATSAPP_NUMBER || WHATSAPP_NUMBER === "TON_NUM_WHATSAPP") return;
    if (turnCount >= SHOW_WHATSAPP_AFTER_TURNS) {
      waWrap.style.display = "block";
      const txt = encodeURIComponent("Bonjour, jâ€™ai une question Ã  propos de ELINEA.");
      waLink.href = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + txt;
    }
  }

  async function sendMsg(forcedText) {
    const text = (forcedText != null ? forcedText : input.value).trim();
    if (!text) return;
    input.value = "";
    addMsg("user", text);
    turnCount += 1;
    maybeShowWhatsApp();

    showTyping(true);

    try {
      const res = await fetch(API_BASE + "/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-session-id": sessionId
        },
        body: JSON.stringify({ message: text, pageUrl: window.location.href })
      });

      const data = await res.json();
      showTyping(false);

      if (!res.ok) {
        addMsg("assistant", data?.answer || "Petit souci technique. Tu peux me redire ?");
        return;
      }

      addMsg("assistant", data.answer || "Je nâ€™ai pas rÃ©ussi Ã  rÃ©pondre. Tu peux reformuler ?");
    } catch (e) {
      showTyping(false);
      addMsg("assistant", "Je nâ€™arrive pas Ã  me connecter. Tu peux essayer dans quelques secondes ?");
    }
  }

  send.onclick = () => sendMsg();
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMsg(); });
</script>
<!-- END ELINEA AI CHAT -->




  </body>
</html>